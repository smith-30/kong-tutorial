# マイクロサービス周り勉強メモ

知らない概念とかOSSについて

## サービスディスカバリ

サービスを構成するコンテナやインスタンスの IP / ポート / ホスト名 を管理する  
これは、クラウドによってスケールアウト/スケールインが用意に可能になり、
そのときのサーバリソースがどういう状況か保持しておいてくれる

Consulは、各ノードに仕込まれたクライアントがマスターのConsulにデータを送ることで構成される  

なので、マイクロサービスが協調するときは、Consulを一回叩いて該当サービスのホストを取得し  
そこにリクエストを投げるようにする?

ECSではサービスディスカバリの機能がサポートされている  
前段にコンテナを束ねたAレコードが設定できるイメージ(従来はALBが必要だった)

### 製品

- Consul
  - Hashi Corp
  - KVストアでもある
- eureka 
  - netflix

### 参考

- https://kiririmode.hatenablog.jp/entry/20180616/1529137711
- https://thinkit.co.jp/story/2015/08/24/6343

## データプレーン

Envoyはネットワークトラフィックを制御するレイヤー

- トラフィックの調整
- トレース

Envoyは他のpodのEnvoyと通信を行い、各サービスにメッセージを伝える

結局、マイクロサービスに特化したLBって感じ? L3,4,7 もイケる

- https://tech.recruit-mp.co.jp/infrastructure/post-17098/
- https://i-beam.org/2019/01/22/hello-envoy/
- https://qiita.com/rerorero/items/0eea0e02955950dd85fc

## コントロールプレーン

- Pliot
  - Envoyに対してトラフィックに応じてルーティングルールを生成して、Envoyに伝える
- Mixer
  - Envoy間のアクセス制御

コントロールプレーン側のEnvoyとデータプレーン側のEnvoy(要は各ノードに入ってるEnvoy)が相互通信することで  
サービス側はネットワークのことを知らずともお互いに通信できる?

ここで利用されるデータ形式が xDS Protocol と呼ばれるもの

## サイドカーパターン

アプリケーションと対になってデプロイされ、補助的な役割をする   
Envoyなどネットワーク周りの世話をするものや  
fluentdのようにログを集めるものなど

## アダプターパターン

コンテナの前段に共通のインターフェースとなるサービスをおいて  
透過的に扱えるようにすること。
nginxとか?

## kong

API gateway

### 参考

- https://github.com/Kong/kong



## OpenResty

nginx の Lua 拡張